version: "3.9"

volumes:
  account_db_data:
  catalog_db_data:
  order_db_data:

services:
  # ==================== GATEWAY PROXY ====================
  gateway_proxy:
    build:
      context: .
      dockerfile: proxy/app.dockerfile
    container_name: gateway_proxy
    ports:
      - "${PROXY_PORT:-80}:80"
    environment:
      - PROXY_PORT=80
      - ACCOUNT_SERVICE_URL=${ACCOUNT_SERVICE_URL}
      - GRAPHQL_GATEWAY_URL=${GRAPHQL_GATEWAY_URL}
      - PROXY_MAX_IDLE_CONNS=${PROXY_MAX_IDLE_CONNS}
      - PROXY_MAX_IDLE_CONNS_PER_HOST=${PROXY_MAX_IDLE_CONNS_PER_HOST}
      - PROXY_IDLE_CONN_TIMEOUT=${PROXY_IDLE_CONN_TIMEOUT}
      - PROXY_REQUEST_TIMEOUT=${PROXY_REQUEST_TIMEOUT}
    depends_on:
      rest:
        condition: service_healthy
      graphql:
        condition: service_healthy
      session_store:
        condition: service_healthy
    restart: unless-stopped

  # ==================== SESSION STORE (REDIS) ====================
  session_store:
    image: redis:7-alpine
    container_name: session_redis
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "${SESSION_REDIS_HOST_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ==================== ACCOUNT DB ====================
  account_db:
    image: postgres:15-alpine
    container_name: account_db
    environment:
      POSTGRES_USER: ${ACCOUNT_DB_USER}
      POSTGRES_PASSWORD: ${ACCOUNT_DB_PASSWORD}
      POSTGRES_DB: ${ACCOUNT_DB_NAME}
    ports:
      - "${ACCOUNT_DB_HOST_PORT:-5433}:5432"
    volumes:
      - account_db_data:/var/lib/postgresql/data
      - ./account/up.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ==================== ACCOUNT SERVICE ====================
  account:
    build:
      context: .
      dockerfile: account/app.dockerfile
    container_name: account_service
    depends_on:
      account_db:
        condition: service_healthy
    environment:
      DATABASE_URL: ${DATABASE_URL_ACCOUNT}
      GRPC_PORT: ${ACCOUNT_GRPC_PORT}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${ACCOUNT_GRPC_PORT}:${ACCOUNT_GRPC_PORT}"
    healthcheck:
      test: ["CMD", "test", "-f", "/app/account-server"]
    restart: unless-stopped

  # ==================== REST GATEWAY ====================
  rest:
    build:
      context: .
      dockerfile: rest/app.dockerfile
    container_name: rest_gateway
    depends_on:
      account:
        condition: service_healthy
      session_store:
        condition: service_healthy
    environment:
      ACCOUNT_GRPC_URL: ${ACCOUNT_GRPC_URL}
      PORT: 8082
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${AUTH_HTTP_PORT:-8082}:8082"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ==================== CATALOG DB (ELASTICSEARCH) ====================
  catalog_db:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.0
    container_name: catalog_db
    environment:
      discovery.type: single-node
      xpack.security.enabled: "false"
      xpack.security.enrollment.enabled: "false"
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "${CATALOG_DB_HOST_PORT:-9200}:9200"
    volumes:
      - catalog_db_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 | grep -q 'You Know, for Search'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ==================== CATALOG SERVICE ====================
  catalog:
    build:
      context: .
      dockerfile: catalog/app.dockerfile
    container_name: catalog_service
    depends_on:
      catalog_db:
        condition: service_healthy
    environment:
      ELASTICSEARCH_URL: ${ELASTICSEARCH_URL}
      ELASTICSEARCH_INDEX: ${ELASTICSEARCH_INDEX:-products}
      GRPC_PORT: ${CATALOG_GRPC_PORT}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${CATALOG_GRPC_PORT}:${CATALOG_GRPC_PORT}"
    healthcheck:
      test: ["CMD", "test", "-f", "/app/catalog-server"]
    restart: unless-stopped

  # ==================== ORDER DB ====================
  order_db:
    image: postgres:15-alpine
    container_name: order_db
    environment:
      POSTGRES_USER: ${ORDER_DB_USER}
      POSTGRES_PASSWORD: ${ORDER_DB_PASSWORD}
      POSTGRES_DB: ${ORDER_DB_NAME}
    ports:
      - "${ORDER_DB_HOST_PORT:-5434}:5432"
    volumes:
      - order_db_data:/var/lib/postgresql/data
      - ./order/up.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ==================== ORDER SERVICE ====================
  order:
    build:
      context: .
      dockerfile: order/app.dockerfile
    container_name: order_service
    depends_on:
      order_db:
        condition: service_healthy
      account:
        condition: service_healthy
      catalog:
        condition: service_healthy
    environment:
      DB_CONNECT_RETRIES: 10
      DATABASE_URL: ${DATABASE_URL_ORDER}
      ACCOUNT_SERVICE_URL: ${ACCOUNT_GRPC_URL}
      CATALOG_SERVICE_URL: ${CATALOG_GRPC_URL}
      GRPC_PORT: ${ORDER_GRPC_PORT}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${ORDER_GRPC_PORT}:${ORDER_GRPC_PORT}"
    healthcheck:
      test: ["CMD", "test", "-f", "/app/order-server"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped

  # ==================== GRAPHQL GATEWAY ====================
  graphql:
    build:
      context: .
      dockerfile: graphql/app.dockerfile
    container_name: graphql_gateway
    depends_on:
      account:
        condition: service_healthy
      catalog:
        condition: service_healthy
      order:
        condition: service_healthy
    environment:
      DB_CONNECT_RETRIES: 10
      ACCOUNT_SERVICE_URL: ${ACCOUNT_GRPC_URL}
      CATALOG_SERVICE_URL: ${CATALOG_GRPC_URL}
      ORDER_SERVICE_URL: ${ORDER_GRPC_URL}
      HTTP_PORT: ${GRAPHQL_HTTP_PORT}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      ENVIRONMENT: ${ENVIRONMENT:-production}
    ports:
      - "${GRAPHQL_HTTP_PORT}:${GRAPHQL_HTTP_PORT}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:${GRAPHQL_HTTP_PORT}/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped
